#!/usr/bin/env ruby
$LOAD_PATH.unshift File.dirname(__FILE__) + '/../lib'
require 'skeptic'
require 'trollop'

opts = Trollop::options do
  Skeptic::Rules.table.each_rule do |klass, slug, option_type, description|
    opt slug, description, type: option_type
  end
end
code = File.read ARGV[0]

critic = Skeptic::Critic.new opts.select { |key, value| Skeptic::Rules.table.slugs.include? key }
critic.criticize code

if critic.criticism.empty?
  puts 'OK'
  exit(0)
else
  messages = Hash.new { |hash, key| hash[key] = [] }

  critic.criticism.each do |message, type|
    messages[type] << message
  end

  messages.each do |type, messages|
    puts type
    messages.each do |message|
      puts "* #{message}"
    end
    puts ""
  end

  exit(1)
end
